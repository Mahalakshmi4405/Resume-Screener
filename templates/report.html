<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Resume Report</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg-1:#0b1220;
      --card:#ffffff;
      --muted:#6b7280;
      --accent-start:#6a7bff;
      --accent-end:#25c2ff;
      --accent-dark:#2b5cff;
      --good-bg: linear-gradient(90deg,#ddfbe6 0%, #bff3d1 100%);
      --bad-bg: linear-gradient(90deg,#ffe7e7 0%, #ffd0d0 100%);
      --rec-bg: linear-gradient(90deg,#fff9d6 0%, #fff1a6 100%);
      --glass-panel: rgba(255,255,255,0.96);
      --shadow: 0 10px 30px rgba(2,6,23,0.45);
      --radius: 14px;
    }
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Tahoma,sans-serif;background:
      radial-gradient(1200px 600px at 10% 10%, rgba(66,59,255,0.06), transparent),
      linear-gradient(180deg,var(--bg-1), #071127); color:#07243a; -webkit-font-smoothing:antialiased;}
    .wrap{display:flex;align-items:flex-start;justify-content:center;padding:28px; gap:20px; box-sizing:border-box;}
    .card{width:980px;max-width:100%;background:linear-gradient(180deg, #fff,#fbfdff);border-radius:var(--radius);padding:20px; box-shadow:var(--shadow); border:1px solid rgba(17,24,39,0.04);}
    .header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;}
    .title{display:flex;gap:14px;align-items:center;}
    .logo{width:56px;height:56px;border-radius:10px;background:linear-gradient(135deg,var(--accent-start),var(--accent-end));display:flex;align-items:center;justify-content:center;color:white;font-weight:800}
    h1{margin:0;font-size:20px;color:var(--accent-dark)}
    .lead{margin:0;color:var(--muted);font-size:13px}
    .header-actions{display:flex;gap:10px;align-items:center}
    .back-link{color:var(--accent-dark);text-decoration:none;border:1px solid rgba(37,194,255,0.10);padding:8px 10px;border-radius:10px;font-weight:600;background:transparent}
    .file-meta{color:var(--muted);font-size:12px;text-align:right}
    .meta-row{display:flex;gap:12px;align-items:center;margin-top:14px;flex-wrap:wrap}
    .badge{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;background:linear-gradient(90deg, rgba(41,65,255,0.05), rgba(37,194,255,0.03));border:1px solid rgba(37,194,255,0.06);color:var(--accent-dark);font-weight:700;font-size:13px}
    .badge .num{font-weight:800;color:var(--accent-dark);margin-left:6px}
    .status-wrap{display:flex;align-items:center;gap:14px;margin-left:auto}
    .progress-wrap{height:14px;width:340px;background:linear-gradient(180deg, rgba(2,6,23,0.04), rgba(2,6,23,0.02));border-radius:8px;overflow:hidden;border:1px solid rgba(2,6,23,0.03)}
    .progress-bar{height:100%;width:0%;background:linear-gradient(90deg,var(--accent-start),var(--accent-end));transition:width 600ms cubic-bezier(.2,.9,.3,1)}
    .status-pill{padding:6px 10px;border-radius:999px;font-weight:700;font-size:13px;color:#063072;background:linear-gradient(90deg,#dbeafe,#e9f5ff);border:1px solid rgba(37,194,255,0.12)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:18px}
    .panel{background:var(--glass-panel);border-radius:12px;padding:14px;min-height:120px;box-shadow:0 6px 18px rgba(10,10,40,0.03);border:1px solid rgba(2,6,23,0.03)}
    .panel h3{margin:0 0 8px 0;color:#0b2b4a;font-size:15px}
    pre{margin:0;font-family:inherit;font-size:13px;color:#082232;white-space:pre-wrap;word-break:break-word}
    .good-list,.bad-list,.rec-list{margin:0;padding:0;list-style:none;display:flex;flex-direction:column;gap:8px}
    .good-list li,.bad-list li,.rec-list li{display:flex;align-items:center;gap:10px;padding:10px;border-radius:10px;font-size:13px;background:transparent}
    .good-list li{background:var(--good-bg)}
    .bad-list li{background:var(--bad-bg)}
    .rec-list li{background:var(--rec-bg)}
    .comparison{margin-top:8px;padding:12px;border-radius:10px;background:linear-gradient(180deg, rgba(37,194,255,0.03), rgba(106,123,255,0.02));border-left:4px solid rgba(106,123,255,0.14);color:#07263a;font-size:13px}
    .actions-row{display:flex;gap:8px;align-items:center}
    .btn{border:none;padding:8px 10px;border-radius:8px;cursor:pointer;font-weight:600}
    .btn-ghost{background:transparent;border:1px solid rgba(2,6,23,0.06)}
    .btn-primary{background:linear-gradient(90deg,var(--accent-start),var(--accent-end));color:white}
    .small{font-size:12px;color:var(--muted)}
    .right-actions{display:flex;gap:8px;align-items:center}
    .snippet { max-height:120px; overflow:hidden; position:relative; }
    .show-more { color:var(--accent-dark); cursor:pointer; font-weight:700; font-size:13px; text-decoration:none }
    .copy-hint { font-size:12px;color:var(--muted) }
    @media (max-width:1000px){ .progress-wrap{width:220px} }
    @media (max-width:760px){ .grid{grid-template-columns:1fr} .status-wrap{width:100%;margin-top:12px;justify-content:space-between} }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" role="main" aria-labelledby="report-title">
      <div class="header">
        <div class="title">
          <div class="logo" aria-hidden="true">AI</div>
          <div>
            <h1 id="report-title">Resume Report</h1>
            <p class="lead">Combined Gemini insights · local similarity · recommendations</p>
          </div>
        </div>

        <div class="header-actions">
          <a class="back-link" href="{{ url_for('upload_resume') }}">← Back</a>
          <div class="file-meta">
            {% if filename %}
              <div style="font-weight:700;">{{ filename }}</div>
            {% endif %}
            <div class="small">ID: {{ id }}</div>
          </div>
        </div>
      </div>

      <div class="meta-row" role="region" aria-label="Summary">
        <div class="badge" title="Local TF-IDF + keyword match">
          Local similarity <span class="num" id="local-sim">{{ similarity or 'N/A' }}</span>%
        </div>

        <div class="badge" title="Gemini combined match">
          Gemini match <span class="num" id="gemini-match">{{ gemini_match_score if gemini_match_score is not none else 'N/A' }}</span>%
        </div>

        <div class="badge" title="Gemini rating out of 10">
          Gemini rating <span class="num" id="gemini-rating">{{ gemini_rating if gemini_rating is not none else 'N/A' }}</span>/10
        </div>

        <div class="status-wrap" aria-hidden="true">
          <div class="progress-wrap" aria-hidden="true">
            <div id="progress-bar" class="progress-bar" style="width: {{ progress or 0 }}%"></div>
          </div>
          <div class="status-pill" id="status-text">{{ status }}</div>
        </div>
      </div>
      <div class="grid" role="region" aria-label="Report content" 
      style="display:grid;grid-template-columns:1fr 1fr;gap:16px;height:100%;">
 
   <!-- Resume -->
   <div class="panel" aria-labelledby="resume-title" 
        style="display:flex;flex-direction:column;border:1px solid #ddd;border-radius:8px;
               padding:10px;background:#fafafa;height:100%;overflow:hidden;">
     <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
       <h3 id="resume-title" style="margin:0;">Resume (snippet)</h3>
       <div class="right-actions" style="display:flex;gap:8px;">
         <button class="btn btn-ghost" onclick="copyFromElementText('resume-pre')">Copy</button>
         <a class="show-more" onclick="toggleExpand('resume-pre')">Show more</a>
       </div>
     </div>
     <pre id="resume-pre"
          style="flex:1;overflow-y:auto;padding:12px;border:1px solid #ccc;border-radius:6px;
                 background:#fff;font-size:14px;white-space:pre-wrap;word-wrap:break-word;
                 max-height:450px;min-height:250px;margin:0;">
 {{ resume_snippet }}
     </pre>
   </div>
 
   <!-- Job -->
   <div class="panel" aria-labelledby="job-title" 
        style="display:flex;flex-direction:column;border:1px solid #ddd;border-radius:8px;
               padding:10px;background:#fafafa;height:100%;overflow:hidden;">
     <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
       <h3 id="job-title" style="margin:0;">Job Description (snippet)</h3>
       <div class="right-actions" style="display:flex;gap:8px;">
         <button class="btn btn-ghost" onclick="copyFromElementText('job-pre')">Copy</button>
         <a class="show-more" onclick="toggleExpand('job-pre')">Show more</a>
       </div>
     </div>
     <pre id="job-pre"
          style="flex:1;overflow-y:auto;padding:12px;border:1px solid #ccc;border-radius:6px;
                 background:#fff;font-size:14px;white-space:pre-wrap;word-wrap:break-word;
                 max-height:450px;min-height:250px;margin:0;">
 {{ job_snippet }}
     </pre>
   </div>
 
 </div>
 
       

        <div class="panel" aria-labelledby="strengths-title">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
            <h3 id="strengths-title">Gemini — Strengths</h3>
            <div class="right-actions">
              <button class="btn btn-ghost" onclick="copyListText('gemini-good')">Copy</button>
            </div>
          </div>
          <ul id="gemini-good" class="good-list" aria-live="polite">
            {% if gemini_good %}
              {% for item in gemini_good.splitlines() %}
                {% if item.strip() %}
                  <li>{{ item.strip("• ").strip() }}</li>
                {% endif %}
              {% endfor %}
            {% else %}
              <li>No strengths found</li>
            {% endif %}
          </ul>
        </div>

        <div class="panel" aria-labelledby="weaknesses-title">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
            <h3 id="weaknesses-title">Gemini — Weaknesses</h3>
            <div class="right-actions">
              <button class="btn btn-ghost" onclick="copyListText('gemini-bad')">Copy</button>
            </div>
          </div>
          <ul id="gemini-bad" class="bad-list" aria-live="polite">
            {% if gemini_bad %}
              {% for item in gemini_bad.splitlines() %}
                {% if item.strip() %}
                  <li>{{ item.strip("• ").strip() }}</li>
                {% endif %}
              {% endfor %}
            {% else %}
              <li>No weaknesses found</li>
            {% endif %}
          </ul>
        </div>

        <div class="panel" style="grid-column:1 / -1;" aria-labelledby="recs-title">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
            <h3 id="recs-title">Recommendations & Comparison</h3>
            <div class="right-actions">
              <button class="btn btn-primary" onclick="downloadJSON()">Download JSON</button>
            </div>
          </div>

          <div style="display:flex;gap:16px;align-items:flex-start;flex-wrap:wrap;">
            <div style="flex:1 1 480px;">
              <strong style="display:block;margin-bottom:8px;">Recommendations</strong>
              <ul id="gemini-recs" class="rec-list" aria-live="polite">
                {% if gemini_recommendations %}
                  {% for item in gemini_recommendations.splitlines() %}
                    {% if item.strip() %}
                      <li>{{ item.strip("• ").strip() }}</li>
                    {% endif %}
                  {% endfor %}
                {% else %}
                  <li>No recommendations</li>
                {% endif %}
              </ul>
            </div>

            <div style="flex:1 1 380px;">
              <strong style="display:block;margin-bottom:8px;">Comparison summary</strong>
              <div id="gemini-comp" class="comparison">{{ gemini_comparison or "No comparison available" }}</div>
              <div style="margin-top:10px;" class="small">Tip: copy comparison to clipboard for pasting into job applications or cover letters.</div>
              <div style="margin-top:8px;">
                <button class="btn btn-ghost" onclick="copyFromElementText('gemini-comp')">Copy comparison</button>
              </div>
            </div>
          </div>

        </div>

      </div> <!-- grid -->
    </div> <!-- card -->
  </div> <!-- wrap -->

<script>
  // Safe copy helpers (read from DOM, not injecting large strings into JS)
  function copyFromElementText(elId) {
    const node = document.getElementById(elId);
    if (!node) return;
    const text = node.innerText || node.textContent || '';
    navigator.clipboard.writeText(text).then(() => {
      // gentle UI feedback
      const old = document.title;
      document.title = 'Copied ✓';
      setTimeout(()=> document.title = old, 900);
    }).catch(()=> alert('Copy failed'));
  }

  function copyListText(listId) {
    const container = document.getElementById(listId);
    if (!container) return;
    const items = Array.from(container.querySelectorAll('li')).map(li => li.innerText.trim()).filter(Boolean);
    if (!items.length) {
      alert('Nothing to copy');
      return;
    }
    navigator.clipboard.writeText(items.join('\n')).then(()=> {
      const old = document.title; document.title = 'Copied ✓'; setTimeout(()=> document.title = old, 900);
    }).catch(()=> alert('Copy failed'));
  }

  function toggleExpand(preId) {
    const el = document.getElementById(preId);
    if (!el) return;
    if (!el.style.maxHeight || el.style.maxHeight === '120px') {
      el.style.maxHeight = (el.scrollHeight + 24) + 'px';
      el.style.overflow = 'auto';
    } else {
      el.style.maxHeight = '120px';
      el.style.overflow = 'hidden';
    }
  }

  function downloadJSON() {
    const getText = id => {
      const n = document.getElementById(id);
      return n ? n.innerText.trim() : '';
    };
    const payload = {
      id: "{{ id }}",
      filename: "{{ filename or '' }}",
      similarity: getText('local-sim'),
      gemini_rating: getText('gemini-rating'),
      gemini_match_score: getText('gemini-match'),
      gemini_good: Array.from(document.querySelectorAll('#gemini-good li')).map(n=>n.innerText.trim()),
      gemini_bad: Array.from(document.querySelectorAll('#gemini-bad li')).map(n=>n.innerText.trim()),
      gemini_recommendations: Array.from(document.querySelectorAll('#gemini-recs li')).map(n=>n.innerText.trim()),
      gemini_comparison: getText('gemini-comp'),
      resume_snippet: getText('resume-pre'),
      job_snippet: getText('job-pre')
    };
    const blob = new Blob([JSON.stringify(payload, null, 2)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = `report_${payload.id}.json`; document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  }

  // Progress + polling logic (similar to your previous behaviour)
  const resumeId = "{{ id }}";

  async function fetchStatusOnce(){
    try {
      const res = await fetch(`/status/${resumeId}`);
      if (!res.ok) return null;
      return await res.json();
    } catch(e) {
      return null;
    }
  }

  function setProgressBar(percent) {
    const el = document.getElementById('progress-bar');
    if (!el) return;
    const clamped = Math.max(0, Math.min(100, Number(percent) || 0));
    el.style.width = clamped + '%';
  }

  function animateNumber(el, toValue, duration = 600) {
    if (!el) return;
    const start = parseFloat(el.innerText) || 0;
    const diff = toValue - start;
    const startTime = performance.now();
    function step(now) {
      const t = Math.min(1, (now - startTime) / duration);
      const eased = (1 - Math.cos(Math.PI * t)) / 2;
      el.innerText = (start + diff * eased).toFixed((toValue % 1 === 0) ? 0 : 2);
      if (t < 1) requestAnimationFrame(step);
    }
    requestAnimationFrame(step);
  }

  function renderListFromText(text, containerId, fallback) {
    const container = document.getElementById(containerId);
    if(!container) return;
    container.innerHTML = '';
    if(!text) {
      container.innerHTML = `<li>${fallback}</li>`;
      return;
    }
    // try JSON array/object
    try {
      const parsed = JSON.parse(text);
      if (Array.isArray(parsed)) {
        parsed.forEach(it => { const li = document.createElement('li'); li.innerText = String(it).trim(); container.appendChild(li); });
        return;
      } else if (typeof parsed === 'object' && parsed !== null) {
        Object.values(parsed).forEach(v => { const li = document.createElement('li'); li.innerText = String(v).trim(); container.appendChild(li); });
        return;
      }
    } catch(_) { /* not JSON */ }

    const lines = text.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
    let items = [];
    lines.forEach(line => {
      if (line.includes('•')) {
        items.push(...line.split('•').map(s => s.trim()).filter(Boolean));
      } else if (line.match(/^\s*-\s+/)) {
        items.push(line.replace(/^\s*-\s+/, '').trim());
      } else {
        items.push(line);
      }
    });
    if (items.length === 0) {
      container.innerHTML = `<li>${fallback}</li>`;
      return;
    }
    items.forEach(it => { const li = document.createElement('li'); li.innerText = it; container.appendChild(li); });
  }

  async function pollStatus(){
    const data = await fetchStatusOnce();
    if (!data) { setTimeout(pollStatus, 1500); return; }

    // animate numbers
    if (data.similarity !== null && data.similarity !== undefined) animateNumber(document.getElementById('local-sim'), Number(data.similarity));
    if (data.gemini_match_score !== null && data.gemini_match_score !== undefined) animateNumber(document.getElementById('gemini-match'), Number(data.gemini_match_score));
    if (data.gemini_rating !== null && data.gemini_rating !== undefined) animateNumber(document.getElementById('gemini-rating'), Number(data.gemini_rating));

    // update progress & status
    setProgressBar(data.progress || 0);
    document.getElementById('status-text').innerText = (data.status || '').toUpperCase();

    // update lists / comparison safely from returned text
    renderListFromText(data.gemini_good || '', 'gemini-good', 'No strengths found');
    renderListFromText(data.gemini_bad || '', 'gemini-bad', 'No weaknesses found');
    renderListFromText(data.gemini_recommendations || '', 'gemini-recs', 'No recommendations');

    if (data.gemini_comparison) document.getElementById('gemini-comp').innerText = String(data.gemini_comparison);

    const stat = (data.status || '').toLowerCase();
    if (stat !== 'done' && stat !== 'failed') {
      setTimeout(pollStatus, 1200);
    } else {
      if (stat === 'done') setProgressBar(100);
    }
  }

  window.addEventListener('load', () => {
    // Only poll if we have a resume id
    if (resumeId && resumeId.length > 0) setTimeout(pollStatus, 600);
  });
</script>
</body>
</html>
